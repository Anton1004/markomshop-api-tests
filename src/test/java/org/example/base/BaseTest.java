package org.example.base;

import io.restassured.RestAssured;
import io.restassured.response.Response;
import org.testng.annotations.BeforeSuite;

import static io.restassured.RestAssured.given;

public class BaseTest {

    /**
     * –≠–¢–û–¢ –ú–ï–¢–û–î –í–ê–ñ–ù–ï–ï –í–°–ï–ì–û - –û–ù –†–ï–®–ê–ï–¢ –ü–†–û–ë–õ–ï–ú–£ 307 –û–®–ò–ë–ö–ò
     *
     * –ü–†–û–ë–õ–ï–ú–ê: –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–∞ Render –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è 2-5 –º–∏–Ω—É—Ç. –ï—Å–ª–∏ —Ç–µ—Å—Ç—ã –∑–∞–ø—É—Å—Ç–∏—Ç—å —Å—Ä–∞–∑—É,
     * –æ–Ω–∏ –ø–æ–ª—É—á–∞—Ç 307 Temporary Redirect –ø–æ—Ç–æ–º—É —á—Ç–æ —Å–µ—Ä–≤–∏—Å –µ—â–µ "–ø—Ä–æ—Å—ã–ø–∞–µ—Ç—Å—è"
     *
     * –†–ï–®–ï–ù–ò–ï: –ü–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º —Ç–µ—Å—Ç–æ–≤ –∂–¥–µ–º –ø–æ–∫–∞ —Å–µ—Ä–≤–∏—Å –ø–æ–ª–Ω–æ—Å—Ç—å—é –∑–∞–ø—É—Å—Ç–∏—Ç—Å—è –∏ –≤–µ—Ä–Ω–µ—Ç 200 OK
     *
     * @BeforeSuite - –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –û–î–ò–ù –†–ê–ó –ø–µ—Ä–µ–¥ –≤—Å–µ–º–∏ —Ç–µ—Å—Ç–∞–º–∏ –≤ suite
     */
    @BeforeSuite
    public void waitForService() {
        System.out.println("‚è≥ –û–∂–∏–¥–∞–µ–º –ø–æ–ª–Ω—ã–π –∑–∞–ø—É—Å–∫ —Å–µ—Ä–≤–∏—Å–∞ –Ω–∞ Render...");
        System.out.println("üì° –ë–∞–∑–æ–≤—ã–π URL: " + RestAssured.baseURI);

        // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –æ–∂–∏–¥–∞–Ω–∏—è
        int maxAttempts = 36;    // –ú–∞–∫—Å–∏–º—É–º 36 –ø–æ–ø—ã—Ç–æ–∫
        int waitSeconds = 5;     // –ñ–¥–µ–º 5 —Å–µ–∫—É–Ω–¥ –º–µ–∂–¥—É –ø–æ–ø—ã—Ç–∫–∞–º–∏
        int totalWaitTime = (maxAttempts * waitSeconds) / 60; // –û–±—â–µ–µ –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è –≤ –º–∏–Ω—É—Ç–∞—Ö

        System.out.println("‚è∞ –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è: " + totalWaitTime + " –º–∏–Ω—É—Ç");

        // –ü—ã—Ç–∞–µ–º—Å—è –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ —Å–µ—Ä–≤–∏—Å—É
        for (int attempt = 1; attempt <= maxAttempts; attempt++) {
            try {
                System.out.println("üîç –ü–æ–ø—ã—Ç–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è " + attempt + "/" + maxAttempts + "...");

                // ‚≠ê‚≠ê‚≠ê –ò–°–ü–†–ê–í–õ–ï–ù–ù–´–ô –ö–û–î - —É–±–∏—Ä–∞–µ–º –Ω–µ–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–π timeout ‚≠ê‚≠ê‚≠ê
                Response response = given()
                        .relaxedHTTPSValidation()  // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º SSL –æ—à–∏–±–∫–∏ (–≤–∞–∂–Ω–æ –¥–ª—è Render)
                        .when()
                        .get("/"); // –ü—Ä–æ—Å—Ç–æ –æ–±—Ä–∞—â–∞–µ–º—Å—è –∫ –∫–æ—Ä–Ω–µ–≤–æ–º—É URL –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è

                int statusCode = response.getStatusCode();
                System.out.println("üìä –ü–æ–ª—É—á–µ–Ω —Å—Ç–∞—Ç—É—Å: " + statusCode);

                // ‚≠ê‚≠ê‚≠ê –ì–õ–ê–í–ù–ê–Ø –ü–†–û–í–ï–†–ö–ê ‚≠ê‚≠ê‚≠ê
                if (statusCode == 200) {
                    System.out.println("‚úÖ –£–°–ü–ï–•! –°–µ—Ä–≤–∏—Å –ø–æ–ª–Ω–æ—Å—Ç—å—é –∑–∞–ø—É—â–µ–Ω –∏ –≥–æ—Ç–æ–≤ –∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é!");
                    System.out.println("üöÄ –ù–∞—á–∏–Ω–∞–µ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤...");
                    return; // –í—ã—Ö–æ–¥–∏–º –∏–∑ –º–µ—Ç–æ–¥–∞ - —Å–µ—Ä–≤–∏—Å –≥–æ—Ç–æ–≤!
                }

                // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –¥—Ä—É–≥–∏—Ö —Å—Ç–∞—Ç—É—Å–∞—Ö
                if (statusCode == 307) {
                    String location = response.getHeader("Location");
                    System.out.println("üîÑ –°–µ—Ä–≤–∏—Å –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ—Ç –Ω–∞: " + location);
                }

            } catch (Exception e) {
                // –õ–æ–≤–∏–º –í–°–ï –∏—Å–∫–ª—é—á–µ–Ω–∏—è - —ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ –∫–æ–≥–¥–∞ —Å–µ—Ä–≤–∏—Å –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è
                System.out.println("‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è: " + e.getMessage());
            }

            // –ñ–¥–µ–º –ø–µ—Ä–µ–¥ —Å–ª–µ–¥—É—é—â–µ–π –ø–æ–ø—ã—Ç–∫–æ–π
            try {
                System.out.println("üí§ –ñ–¥–µ–º " + waitSeconds + " —Å–µ–∫—É–Ω–¥...");
                Thread.sleep(waitSeconds * 1000);
            } catch (InterruptedException ie) {
                Thread.currentThread().interrupt();
                break;
            }
        }

        // –ï—Å–ª–∏ –¥–æ—à–ª–∏ —Å—é–¥–∞ - —Å–µ—Ä–≤–∏—Å —Ç–∞–∫ –∏ –Ω–µ –∑–∞–ø—É—Å—Ç–∏–ª—Å—è
        System.out.println("‚ö†Ô∏è  –í–ù–ò–ú–ê–ù–ò–ï: –°–µ—Ä–≤–∏—Å –Ω–µ –∑–∞–ø—É—Å—Ç–∏–ª—Å—è –∑–∞ " + totalWaitTime + " –º–∏–Ω—É—Ç!");
        System.out.println("üîß –¢–µ—Å—Ç—ã –±—É–¥—É—Ç –∑–∞–ø—É—â–µ–Ω—ã, –Ω–æ –º–æ–≥—É—Ç –ø–∞–¥–∞—Ç—å –∏–∑-–∑–∞ 307 –æ—à–∏–±–æ–∫");
    }
}